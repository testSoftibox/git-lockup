#tmp -*- python -*-

#tmp This template is used by the git-assure tool to create ./setup-assure .
#tmp It includes an encoded copy of .git/assure-tool. When ./setup-assure is
#tmp run by a client (someone who has just cloned the repo and wants to begin
#tmp protecting their fetches), ./setup-assure will use its encoded copy to
#tmp create .git/assure-tool, and then read the branch/pubkey list from the
#tmp neighboring assure.config file to modify .git/config

# Welcome to git-assure!

# By running this program, your git checkout will be configured to check
# per-revision signatures every time you fetch new changes. This will
# ensure that you only get changes from the upstream author of this
# project, preventing unauthorized commits injected at any intermediate
# repositories or hosting providers.

#<-- common

assure_tool_b64 = """
#<-- assure_tool-b64
"""

#<-- setup-client

# install .git/assure-tool
assert os.path.isdir(".git")
tool = ".git/assure-tool"
f = open(tool, "wb")
f.write(base64.b64decode(assure_tool_b64))
f.close()
make_executable(tool)

from ConfigParser import SafeConfigParser
config = SafeConfigParser()
config.readfp(open("assure.config"))

for branch,keys in config.items("branches"):
    remote = get_config("branch.%s.remote" % branch)
    assert remote
    for key in keys.split():
        setup_client(remote, branch, key)
